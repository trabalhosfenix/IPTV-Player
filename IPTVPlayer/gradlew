#!/bin/bash
#
# Gradle start up script for UN*X
#

set -e

# Attempt to set APP_HOME
PRG="$0"
while [ -h "$PRG" ] ; do
    ls -ld "$PRG"
    PRG=`readlink "$PRG"`
done
SAVED="`pwd`"
cd "`dirname "$PRG"`/.." >/dev/null
APP_HOME="`pwd -P`"
cd "$SAVED" >/dev/null

APP_NAME="Gradle"
APP_BASE_NAME=`basename "$0"`

# Add default JVM options
DEFAULT_JVM_OPTS="-Xmx64m -Xms64m"

# Determine the Java command to use
if [ -n "$JAVA_HOME" ]; then
    if [ -x "$JAVA_HOME/jre/sh/java" ]; then
        JAVACMD="$JAVA_HOME/jre/sh/java"
    else
        JAVACMD="$JAVA_HOME/bin/java"
    fi
else
    JAVACMD="java"
fi

# Setup the wrapper directory
WRAPPER_DIR="$APP_HOME/gradle/wrapper"
WRAPPER_JAR="$WRAPPER_DIR/gradle-wrapper.jar"
WRAPPER_PROPS="$WRAPPER_DIR/gradle-wrapper.properties"

# Download gradle wrapper if it doesn't exist
if [ ! -f "$WRAPPER_JAR" ]; then
    mkdir -p "$WRAPPER_DIR"
    echo "Downloading gradle wrapper..."
    
    # Read the gradle URL from properties
    if [ -f "$WRAPPER_PROPS" ]; then
        GRADLE_URL=$(grep distributionUrl "$WRAPPER_PROPS" | cut -d'=' -f2 | sed 's/\\/\//g')
    else
        GRADLE_URL="https://services.gradle.org/distributions/gradle-7.5-bin.zip"
    fi
    
    TEMP_ZIP="/tmp/gradle-wrapper.zip"
    curl -L "$GRADLE_URL" -o "$TEMP_ZIP"
    
    TEMP_DIR="/tmp/gradle-extracted"
    rm -rf "$TEMP_DIR"
    mkdir -p "$TEMP_DIR"
    unzip -q "$TEMP_ZIP" -d "$TEMP_DIR"
    
    # Find and copy the wrapper jar
    find "$TEMP_DIR" -name "gradle-wrapper.jar" -exec cp {} "$WRAPPER_JAR" \;
    
    # Cleanup
    rm -f "$TEMP_ZIP"
    rm -rf "$TEMP_DIR"
fi

# Execute Gradle
exec "$JAVACMD" $DEFAULT_JVM_OPTS -classpath "$WRAPPER_JAR" org.gradle.wrapper.GradleWrapperMain "$@"
